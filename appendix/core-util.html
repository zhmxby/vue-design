<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue技术内幕 | core/util 目录下的工具方法全解</title>
    <meta name="description" content="逐行级别的 Vue 源码分析">
    <script async="" src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    <link rel="preload" href="/vue-design/assets/css/0.styles.efeaeef6.css" as="style"><link rel="preload" href="/vue-design/assets/js/app.d8bc048b.js" as="script"><link rel="preload" href="/vue-design/assets/js/26.28b25aff.js" as="script"><link rel="prefetch" href="/vue-design/assets/js/15.a05ccb6a.js"><link rel="prefetch" href="/vue-design/assets/js/1.c0f36928.js"><link rel="prefetch" href="/vue-design/assets/js/2.243eafc6.js"><link rel="prefetch" href="/vue-design/assets/js/3.328d087e.js"><link rel="prefetch" href="/vue-design/assets/js/4.65876344.js"><link rel="prefetch" href="/vue-design/assets/js/5.1d20582e.js"><link rel="prefetch" href="/vue-design/assets/js/6.2a50a950.js"><link rel="prefetch" href="/vue-design/assets/js/7.309b3f1b.js"><link rel="prefetch" href="/vue-design/assets/js/8.7b9253b0.js"><link rel="prefetch" href="/vue-design/assets/js/9.833128f6.js"><link rel="prefetch" href="/vue-design/assets/js/10.456f05ec.js"><link rel="prefetch" href="/vue-design/assets/js/11.6917b5a3.js"><link rel="prefetch" href="/vue-design/assets/js/12.7d70aaa0.js"><link rel="prefetch" href="/vue-design/assets/js/13.0af741e3.js"><link rel="prefetch" href="/vue-design/assets/js/14.7b35b606.js"><link rel="prefetch" href="/vue-design/assets/js/16.1ba9e9af.js"><link rel="prefetch" href="/vue-design/assets/js/17.0b020260.js"><link rel="prefetch" href="/vue-design/assets/js/18.34bd5537.js"><link rel="prefetch" href="/vue-design/assets/js/19.2f8a9292.js"><link rel="prefetch" href="/vue-design/assets/js/20.6dae14aa.js"><link rel="prefetch" href="/vue-design/assets/js/21.778c357e.js"><link rel="prefetch" href="/vue-design/assets/js/22.ea05ebc0.js"><link rel="prefetch" href="/vue-design/assets/js/23.42000ae2.js"><link rel="prefetch" href="/vue-design/assets/js/24.da29a388.js"><link rel="prefetch" href="/vue-design/assets/js/25.cbb8f279.js"><link rel="prefetch" href="/vue-design/assets/js/27.b5e6082d.js"><link rel="prefetch" href="/vue-design/assets/js/28.48fbdee8.js"><link rel="prefetch" href="/vue-design/assets/js/29.a5e58d92.js"><link rel="prefetch" href="/vue-design/assets/js/30.98deb4e9.js"><link rel="prefetch" href="/vue-design/assets/js/31.5c4e6863.js">
    <link rel="stylesheet" href="/vue-design/assets/css/0.styles.efeaeef6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/vue-design/" class="home-link router-link-active"><!----><span class="site-name">
      Vue技术内幕
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/vue-design/art/" class="nav-link">正文</a></div><div class="nav-item"><a href="/vue-design/appendix/" class="nav-link router-link-active">附录</a></div><div class="nav-item"><a href="/vue-design/more/" class="nav-link">扩展阅读</a></div><div class="nav-item"><a href="/vue-design/donate/" class="nav-link">人之初</a></div><div class="nav-item"><a href="/vue-design/about/" class="nav-link">关于</a></div><a href="https://github.com/HcySunYang/vue-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue-design/art/" class="nav-link">正文</a></div><div class="nav-item"><a href="/vue-design/appendix/" class="nav-link router-link-active">附录</a></div><div class="nav-item"><a href="/vue-design/more/" class="nav-link">扩展阅读</a></div><div class="nav-item"><a href="/vue-design/donate/" class="nav-link">人之初</a></div><div class="nav-item"><a href="/vue-design/about/" class="nav-link">关于</a></div><a href="https://github.com/HcySunYang/vue-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><div><ins data-ad-client="ca-pub-4613560834313397" data-ad-slot="2465217753" class="adsbygoogle" style="display:block;box-sizing:border-box;width:100%;height:120px;margin:10px auto 0;"></ins></div><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>附录</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/vue-design/appendix/" class="sidebar-link">附录</a></li><li><a href="/vue-design/appendix/vue-prototype.html" class="sidebar-link">Vue 构造函数整理-原型</a></li><li><a href="/vue-design/appendix/vue-global-api.html" class="sidebar-link">Vue 构造函数整理-全局API</a></li><li><a href="/vue-design/appendix/vue-ins.html" class="sidebar-link">Vue 实例的设计</a></li><li><a href="/vue-design/appendix/core-util.html" class="active sidebar-link">core/util 目录下的工具方法全解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#debug-js-文件代码说明" class="sidebar-link">debug.js 文件代码说明</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#warn" class="sidebar-link">warn</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#tip" class="sidebar-link">tip</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#formatcomponentname" class="sidebar-link">formatComponentName</a></li></ul></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#env-js-文件代码说明" class="sidebar-link">env.js 文件代码说明</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#inbrowser" class="sidebar-link">inBrowser</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#ua" class="sidebar-link">UA</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#isie" class="sidebar-link">isIE</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#hasproto" class="sidebar-link">hasProto</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#nativewatch" class="sidebar-link">nativeWatch</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#isserverrendering" class="sidebar-link">isServerRendering</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#hassymbol" class="sidebar-link">hasSymbol</a></li></ul></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#error-js-文件代码说明" class="sidebar-link">error.js 文件代码说明</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#handleerror" class="sidebar-link">handleError</a></li></ul></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#lang-js-文件代码说明" class="sidebar-link">lang.js 文件代码说明</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#isreserved" class="sidebar-link">isReserved</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#def" class="sidebar-link">def</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#parsepath" class="sidebar-link">parsePath</a></li></ul></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#options-js-文件代码说明" class="sidebar-link">options.js 文件代码说明</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#perf-js-文件代码说明" class="sidebar-link">perf.js 文件代码说明</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#props-js-文件代码说明" class="sidebar-link">props.js 文件代码说明</a></li><li class="sidebar-sub-header"><a href="/vue-design/appendix/core-util.html#next-tick-js-文件代码说明" class="sidebar-link">next-tick.js 文件代码说明</a></li></ul></li><li><a href="/vue-design/appendix/web-util.html" class="sidebar-link">platforms/web/util 目录下的工具方法全解</a></li><li><a href="/vue-design/appendix/shared-util.html" class="sidebar-link">shared/util.js 文件工具方法全解</a></li><li><a href="/vue-design/appendix/compiler-options.html" class="sidebar-link">编译器选项</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="core-util-目录下的工具方法全解"><a href="#core-util-目录下的工具方法全解" aria-hidden="true" class="header-anchor">#</a> core/util 目录下的工具方法全解</h1><h2 id="debug-js-文件代码说明"><a href="#debug-js-文件代码说明" aria-hidden="true" class="header-anchor">#</a> debug.js 文件代码说明</h2><p>该文件主要导出四个函数，如下：</p><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">let</span> warn <span class="token operator">=</span> noop
<span class="token keyword">export</span> <span class="token keyword">let</span> tip <span class="token operator">=</span> noop
<span class="token keyword">export</span> <span class="token keyword">let</span> generateComponentTrace <span class="token operator">=</span> <span class="token punctuation">(</span>noop<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token comment">// work around flow check</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> formatComponentName <span class="token operator">=</span> <span class="token punctuation">(</span>noop<span class="token punctuation">:</span> any<span class="token punctuation">)</span>
</code></pre><p>这四个变量都被初始化为空函数·</p><p>接下来是这样一段代码：</p><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><p>这些代码被包含在一个环境判断的语句块内，这说明，这些代码只有在非生产环境才会生效，而在这些代码中我们能看到如下语句：</p><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 其他代码...</span>

  <span class="token function-variable function">warn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">tip</span> <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">formatComponentName</span> <span class="token operator">=</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> includeFile<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">generateComponentTrace</span> <span class="token operator">=</span> vm <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>上面的代码是简化过的，可以发现，在非生产环境下分别对 <code>warn</code>、<code>tip</code>、<code>formatComponentName</code> 以及 <code>generateComponentTrace</code> 进行了赋值，且值都为函数，接下来我们分别看一下这四个函数的作用，不过在这之前，我们需要介绍三个变量，也就是 <code>if</code> 语句块最开始的三个变量：</p><pre class="language-js"><code><span class="token keyword">const</span> hasConsole <span class="token operator">=</span> <span class="token keyword">typeof</span> console <span class="token operator">!==</span> <span class="token string">'undefined'</span>
<span class="token keyword">const</span> classifyRE <span class="token operator">=</span> <span class="token regex">/(?:^|[-_])(\w)/g</span>
<span class="token keyword">const</span> <span class="token function-variable function">classify</span> <span class="token operator">=</span> str <span class="token operator">=&gt;</span> str
  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>classifyRE<span class="token punctuation">,</span> c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[-_]/g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
</code></pre><p>其中 <code>hasConsole</code> 用来检测宿主环境的 <code>console</code> 是否可用，<code>classifyRE</code> 是一个正则表达式：<code>/(?:^|[-_])(\w)/g</code>，用于 <code>classify</code> 函数，<code>classify</code> 函数的作用是将一个字符串的首字母以及中横线转为驼峰的，代码很简单相信大家都能看得懂，<code>classify</code> 的使用如下：</p><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">classify</span><span class="token punctuation">(</span><span class="token string">'aaa-bbb-ccc'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// AaaBbbCcc</span>
</code></pre><h3 id="warn"><a href="#warn" aria-hidden="true" class="header-anchor">#</a> warn</h3><h3 id="tip"><a href="#tip" aria-hidden="true" class="header-anchor">#</a> tip</h3><h3 id="formatcomponentname"><a href="#formatcomponentname" aria-hidden="true" class="header-anchor">#</a> formatComponentName</h3><h2 id="env-js-文件代码说明"><a href="#env-js-文件代码说明" aria-hidden="true" class="header-anchor">#</a> env.js 文件代码说明</h2><h3 id="inbrowser"><a href="#inbrowser" aria-hidden="true" class="header-anchor">#</a> inBrowser</h3><p>源码如下：</p><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> inBrowser <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span>
</code></pre><ul><li><p>描述：检测当前宿主环境是否是浏览器</p></li><li><p>源码解析：通过判断 <code>window</code> 对象是否存在即可</p></li></ul><h3 id="ua"><a href="#ua" aria-hidden="true" class="header-anchor">#</a> UA</h3><p>源码如下：</p><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">UA</span> <span class="token operator">=</span> inBrowser <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><ul><li><p>描述：获取当浏览器的 <code>user Agent</code>，简称 <code>UA</code>。</p></li><li><p>源码解析：首先使用 <code>inBrowser</code> 检测当前宿主环境是否是浏览器，如果是则通过 <code>window.navigator.userAgent.toLowerCase()</code> 获取当前浏览器的 <code>UA</code> 字符串，并将该字符串小写化之后赋值给 <code>UA</code> 常量。</p></li></ul><h3 id="isie"><a href="#isie" aria-hidden="true" class="header-anchor">#</a> isIE</h3><p>源码如下：</p><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> isIE <span class="token operator">=</span> <span class="token constant">UA</span> <span class="token operator">&amp;&amp;</span> <span class="token regex">/msie|trident/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token constant">UA</span><span class="token punctuation">)</span>
</code></pre><ul><li><p>描述：判断当前浏览器是否是 <code>Internet Explorer</code> 浏览器。</p></li><li><p>源码解析：</p></li></ul><p>大家可以访问这里 <a href="http://useragentstring.com/pages/useragentstring.php?name=Internet+Explorer" target="_blank" rel="noopener noreferrer">Internet Explorer User Agent Strings</a> 查看 <code>IE2</code> 到 <code>IE11</code> 所有版本的用户代理字符串，我们能够发现在这些 <code>UA</code> 字符串中必然包含 <code>'trident'</code> 或者 <code>'msie'</code> 这两个字符串。所以只需要使用正则去匹配 <code>UA</code> 中是否包含这两个字符串即可判断是否为 <code>IE</code> 浏览器。</p><h3 id="hasproto"><a href="#hasproto" aria-hidden="true" class="header-anchor">#</a> hasProto</h3><p>源码如下：</p><pre class="language-js"><code><span class="token comment">// can we use __proto__?</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> hasProto <span class="token operator">=</span> <span class="token string">'__proto__'</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><ul><li><p>描述：<code>hasProto</code> 用来检查当前环境是否可以使用对象的 <code>__proto__</code> 属性。我们知道，一个对象的 <code>__proto__</code> 属性指向了它构造函数的原型，但这是一个在 <code>ES2015</code> 中才被标准化的属性，<code>IE11</code> 及更高版本才能够使用。</p></li><li><p>源码解析：</p></li></ul><p>判断当前环境是否可以使用 <code>__proto__</code> 属性很简单，正如源码所示那样，使用 <code>in</code> 运算符从一个空的对象字面量开始沿着原型链逐级检查，看其是否存在即可。</p><h3 id="nativewatch"><a href="#nativewatch" aria-hidden="true" class="header-anchor">#</a> nativeWatch</h3><p>源码如下：</p><pre class="language-js"><code><span class="token comment">// Firefox has a &quot;watch&quot; function on Object.prototype...</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> nativeWatch <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>watch
</code></pre><ul><li>描述：在 <code>Firefox</code> 中原生提供了 <code>Object.prototype.watch</code> 函数，所以当运行在 <code>Firefox</code> 中时 <code>nativeWatch</code> 为原生提供的函数，在其他浏览器中 <code>nativeWatch</code> 为 <code>undefined</code>。这个变量主要用于 <code>Vue</code> 处理 <code>watch</code> 选项时与其冲突。</li></ul><h3 id="isserverrendering"><a href="#isserverrendering" aria-hidden="true" class="header-anchor">#</a> isServerRendering</h3><p>源码如下：</p><pre class="language-js"><code><span class="token comment">// this needs to be lazy-evaled because vue may be required before</span>
<span class="token comment">// vue-server-renderer can set VUE_ENV</span>
<span class="token keyword">let</span> _isServer
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">isServerRendering</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_isServer <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inWeex <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> global <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// detect presence of vue-server-renderer and avoid</span>
      <span class="token comment">// Webpack shimming the process</span>
      _isServer <span class="token operator">=</span> global<span class="token punctuation">[</span><span class="token string">'process'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_ENV</span> <span class="token operator">===</span> <span class="token string">'server'</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      _isServer <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> _isServer
<span class="token punctuation">}</span>
</code></pre><ul><li><p>描述：<code>isServerRendering</code> 函数的执行结果是一个布尔值，用来判断是否是服务端渲染。</p></li><li><p>源码解析：</p></li></ul><p>根据 <code>if</code> 语句：</p><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inWeex <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> global <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre><p>可知如果不在浏览器中(<code>!inBrowser</code>)也不是weex(<code>!inWeex</code>)，同时 <code>global</code> 有定义，则可能是服务端渲染，那么继续判断：</p><pre class="language-js"><code>global<span class="token punctuation">[</span><span class="token string">'process'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_ENV</span> <span class="token operator">===</span> <span class="token string">'server'</span>
</code></pre><p>是否成立，其中 <code>global['process'.env.VUE_ENV]</code> 是 <code>vue-server-renderer</code> 注入的。如果成立那么说明是服务端渲染。如果上面的条件有一项不成立，那么都不认为是服务端渲染。</p><p>注意，在 <code>isServerRendering</code> 中使用全局变量 <code>_isServer</code> 保存了最终的值，如果发现 <code>_isServer</code> 有定义，那么就不会重新计算，从而提升性能。毕竟环境是不会改变的，只需要求值一次即可。</p><h3 id="hassymbol"><a href="#hassymbol" aria-hidden="true" class="header-anchor">#</a> hasSymbol</h3><p>源码如下：</p><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> hasSymbol <span class="token operator">=</span>
  <span class="token keyword">typeof</span> Symbol <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  <span class="token keyword">typeof</span> Reflect <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>Reflect<span class="token punctuation">.</span>ownKeys<span class="token punctuation">)</span>
</code></pre><ul><li><p>描述：<code>hasSymbol</code> 常量是一个布尔值，用来判断当前宿主环境是否支持原生 <code>Symbol</code> 和 <code>Reflect.ownKeys</code> 的可用性。</p></li><li><p>源码解析：</p></li></ul><p>首先判断 <code>Symbol</code> 和 <code>Reflect</code> 是否存在，并使用 <code>isNative</code> 函数保证 <code>Symbol</code> 与 <code>Reflect.ownKeys</code> 全部是原生定义。</p><h2 id="error-js-文件代码说明"><a href="#error-js-文件代码说明" aria-hidden="true" class="header-anchor">#</a> error.js 文件代码说明</h2><p>该文件只导出一个函数：<code>handleError</code>，在看这个函数的实现之前，我们需要回顾一下 <code>Vue</code> 的文档，我们知道 <code>Vue</code> 提供了一个全局配置 <code>errorHandler</code>，用来捕获组件生命周期函数等的内部错误，使用方法如下：</p><pre class="language-js"><code>Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><p>我们通过设置 <code>Vue.config.errorHandler</code> 为一个函数，实现对特定错误的捕获。具体使用可以查看官方文档。而接下来要讲的 <code>handleError</code> 函数就是用来实现 <code>Vue.config.errorHandler</code> 这一配置功能的，我们看看是怎么做的。</p><h3 id="handleerror"><a href="#handleerror" aria-hidden="true" class="header-anchor">#</a> handleError</h3><p>源码如下：</p><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">handleError</span> <span class="token punctuation">(</span>err<span class="token punctuation">:</span> Error<span class="token punctuation">,</span> vm<span class="token punctuation">:</span> any<span class="token punctuation">,</span> info<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cur <span class="token operator">=</span> vm
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>$parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> hooks <span class="token operator">=</span> cur<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>errorCaptured
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hooks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> capture <span class="token operator">=</span> hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>capture<span class="token punctuation">)</span> <span class="token keyword">return</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">globalHandleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> <span class="token string">'errorCaptured hook'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">globalHandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><ul><li><p>描述：用于错误处理</p></li><li><p>参数：</p><ul><li><code>{Error} err</code> catch 到的错误对象，我们可以看到 Vue 源码中是这样使用的：</li></ul></li></ul><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hook<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> hook`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><pre><code>* `{any} vm` 这里应该传递 `Vue` 实例
* `{String} info` `Vue` 特定的错误提示信息
</code></pre><ul><li>源码分析</li></ul><p>首先迎合一下使用场景，在 <code>Vue</code> 的源码中 <code>handleError</code> 函数的使用一般如下：</p><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hook<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> hook`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>上面是生命周期钩子回调执行时的代码，由于生命周期钩子是开发者自定义的函数，这个函数的执行是很可能存在运行时错误的，所以这里需要 <code>try catch</code> 包裹，且在发生错误的时候，在 <code>catch</code> 语句块中捕获错误，然后使用 <code>handleError</code> 进行错误处理。知道了这些，我们再看看 <code>handleError</code> 到底怎么处理的，源码上面已经贴出来了，首先是一个 <code>if</code> 判断：</p><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> cur <span class="token operator">=</span> vm
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>$parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cur<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>errorCaptured<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> propagate <span class="token operator">=</span> cur<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>errorCaptured<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>propagate<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">globalHandleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> <span class="token string">'errorCaptured hook'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>那这段代码是干嘛的呢？我们先不管，回头来说。我们先看后面的代码，在判断语句后面直接调用了 <code>globalHandleError</code> 函数，且将三个参数透传了过去：</p><pre class="language-js"><code><span class="token function">globalHandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
</code></pre><p><code>globalHandleError</code> 函数就定义在 <code>handleError</code> 函数的下面，源码如下：</p><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">globalHandleError</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>errorHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> config<span class="token punctuation">.</span>errorHandler<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">logError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'config.errorHandler'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">logError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p><code>globalHandleError</code> 函数首先判断 <code>config.errorHandler</code> 是否为真，如果为真则调用 <code>config.errorHandler</code> 并将参数透传，这里的 <code>config.errorHandler</code> 就是 <code>Vue</code> 全局API提供的用于自定义错误处理的配置我们前面讲过。由于这个错误处理函数也是开发者自定义的，所以可能出现运行时错误，这个时候就需要使用 <code>try catch</code> 语句块包裹起来，当错误发生时，使用 <code>logError</code> 函数打印错误，当然啦，如果没有配置 <code>config.errorHandler</code> 也就是说 <code>config.errorHandler</code> 此时为假，那么将使用默认的错误处理函数，也就是 <code>logError</code> 进行错误处理。</p><p>所以 <code>globalHandleError</code> 是用来检测你是否自定义了 <code>config.errorHandler</code> 的，如果有则用之，如果没有就是用 <code>logError</code>。</p><p>那么 <code>logError</code> 是什么呢？这个函数定义在 <code>globalHandleError</code> 函数的下面，源码如下：</p><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">logError</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Error in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>info<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* istanbul ignore else */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>inBrowser <span class="token operator">||</span> inWeex<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> console <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> err
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>可以看到，在非生产环境下，先使用 <code>warn</code> 函数报一个警告，然后判断是否在浏览器或者Weex环境且 <code>console</code> 是否可用，如果可用则使用 <code>console.error</code> 打印错误，没有则直接 <code>throw err</code>。</p><p>所以 <code>logError</code> 才真正打印错误的函数，且实现也比较简单。这其实已经达到了 <code>handleError</code> 的目的了，但是大家注意我们此时忽略了一段代码，就是 <code>handleError</code> 函数开头的一段代码：</p><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> cur <span class="token operator">=</span> vm
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>$parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hooks <span class="token operator">=</span> cur<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>errorCaptured
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hooks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> capture <span class="token operator">=</span> hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>capture<span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">globalHandleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> <span class="token string">'errorCaptured hook'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>那么这个 <code>if</code> 判断是干嘛的呢？这其实是 <code>Vue</code> 选项 <code>errorCaptured</code> 的实现。实际上我们可以这样写代码：</p><pre class="language-js"><code><span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  errorCaptured<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p><code>errorCaptured</code> 选项可以用来捕获子代组件的错误，当子组件有错误被 <code>handleError</code> 函数处理时，父组件可以通过该选项捕获错误。这个选项与生命周期钩子并列。</p><p>举一个例子，如下代码：</p><pre class="language-js"><code><span class="token keyword">var</span> ChildComponent <span class="token operator">=</span> <span class="token punctuation">{</span>
  template<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;child component&lt;/div&gt;'</span><span class="token punctuation">,</span>
  beforeCreate<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;};&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  components<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    ChildComponent
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  errorCaptured<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>上面的代码中，首先我们定义了一个子组件 <code>ChildComponent</code>，并且在 <code>ChildComponent</code> 的 <code>beforeCreate</code> 钩子中写了如下代码：</p><pre class="language-js"><code><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;};&quot;</span><span class="token punctuation">)</span>
</code></pre><p>这明显会报错嘛，然后我们在父组件中使用了 <code>errorCaptured</code> 选项，这样是可以捕获到错误的。</p><p>接下来我们就看看 <code>Vue</code> 是怎么实现的，原理就在这段代码中：</p><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> cur <span class="token operator">=</span> vm
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>$parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hooks <span class="token operator">=</span> cur<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>errorCaptured
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hooks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> capture <span class="token operator">=</span> hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>capture<span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">globalHandleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> <span class="token string">'errorCaptured hook'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>首先看这个 <code>while</code> 循环：</p><pre class="language-js"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>$parent<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>这是一个链表遍历嘛，逐层寻找父级组件，如果父级组件使用了 <code>errorCaptured</code> 选项，则调用之，就怎么简单。当然啦，作为生命周期钩子，<code>errorCaptured</code> 选项在内部时以一个数组的形式存在的，所以需要 <code>for</code> 循环遍历，另外钩子执行的语句是被包裹在 <code>try catch</code> 语句块中的。</p><p>这里有两点需要注意：</p><ul><li>第一、既然是逐层寻找父级，那意味着，如果一个子组件报错，那么其使用了 <code>errorCaptured</code> 的所有父代组件都可以捕获得到。</li><li>第二、注意这句话：</li></ul><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>capture<span class="token punctuation">)</span> <span class="token keyword">return</span>
</code></pre><p>其中 <code>capture</code> 是钩子调用的返回值与 <code>false</code> 的全等比较的结果，也就是说，如果 <code>errorCaptured</code> 钩子函数返回假，那么 <code>capture</code> 为真直接 <code>return</code>，程序不会走 <code>if</code> 语句块后面的 <code>globalHandleError</code>，否则除了 <code>errorCaptured</code> 被调用外，<code>if</code> 语句块后面的 <code>globalHandleError</code> 也会被调用。最总要的是：如果 <code>errorCaptured</code> 钩子函数返回假将阻止错误继续向“上级”传递。</p><h2 id="lang-js-文件代码说明"><a href="#lang-js-文件代码说明" aria-hidden="true" class="header-anchor">#</a> lang.js 文件代码说明</h2><h3 id="isreserved"><a href="#isreserved" aria-hidden="true" class="header-anchor">#</a> isReserved</h3><ul><li>源码如下：</li></ul><pre class="language-js"><code><span class="token comment">/**
 * Check if a string starts with $ or _
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isReserved</span> <span class="token punctuation">(</span>str<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token punctuation">(</span>str <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> c <span class="token operator">===</span> <span class="token number">0x24</span> <span class="token operator">||</span> c <span class="token operator">===</span> <span class="token number">0x5F</span>
<span class="token punctuation">}</span>
</code></pre><ul><li>描述：<code>isReserved</code> 函数用来检测一个字符串是否以 <code>$</code> 或者 <code>_</code> 开头，主要用来判断一个字段的键名是否保留的，比如在 <code>Vue</code> 中不允许使用以 <code>$</code> 或 <code>_</code> 开头的字符串作为 <code>data</code> 数据的字段名，如：</li></ul><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    $a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// 不允许</span>
    _b<span class="token punctuation">:</span> <span class="token number">2</span>   <span class="token comment">// 不允许</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><ul><li>源码分析：</li></ul><p>判断一个字符串是否以 <code>$</code> 或 <code>_</code> 开头还是比较容易的，只不过 <code>isReserved</code> 函数的实现方式是通过字符串的 <code>charCodeAt</code> 方法获得该字符串第一个字符串的 <code>unicode</code>，然后与 <code>0x24</code> 和 <code>0x5F</code> 作比较。其中 <code>$</code> 对应的 <code>unicode</code> 码为 <code>36</code>，对应的十六进制值为 <code>0x24</code>；<code>_</code> 对应的 <code>unicode</code> 码为 <code>95</code>，对应的十六进制值为 <code>0x5F</code>。有的同学可能会有疑问为什么不直接用字符 <code>$</code> 和 <code>_</code> 作比较，而是用这两个字符对应的 <code>unicode</code> 码作比较，其实无论哪种比较方法差别不大，看作者更倾向于哪一种。</p><h3 id="def"><a href="#def" aria-hidden="true" class="header-anchor">#</a> def</h3><ul><li>源码如下：</li></ul><pre class="language-js"><code><span class="token comment">/**
 * Define a property.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">def</span> <span class="token punctuation">(</span>obj<span class="token punctuation">:</span> Object<span class="token punctuation">,</span> key<span class="token punctuation">:</span> string<span class="token punctuation">,</span> val<span class="token punctuation">:</span> any<span class="token punctuation">,</span> enumerable<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> val<span class="token punctuation">,</span>
    enumerable<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token operator">!</span>enumerable<span class="token punctuation">,</span>
    writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><ul><li><p>描述：<code>def</code> 函数是对 <code>Object.defineProperty</code> 函数的简单包装，为了调用方便</p></li><li><p>源码分析：</p></li></ul><p><code>def</code> 函数接收四个参数，分别是 源对象，要在对象上定义的键名，对应的值，以及是否可枚举，如果不传递 <code>enumerable</code> 参数则代表定义的属性是不可枚举的。</p><h3 id="parsepath"><a href="#parsepath" aria-hidden="true" class="header-anchor">#</a> parsePath</h3><ul><li><code>parsePath</code> 函数的源码在 <a href="/vue-design/art/8vue-reactive-dep-watch.html#初识-watcher">初始 Watcher</a> 一节中讲解</li></ul><h2 id="options-js-文件代码说明"><a href="#options-js-文件代码说明" aria-hidden="true" class="header-anchor">#</a> options.js 文件代码说明</h2><p><em>该文件的讲解集中在 <a href="/vue-design/art/4vue-normalize.html">Vue选项的规范化</a> 以及 <a href="/vue-design/art/5vue-merge.html">Vue选项的合并</a> 这两个小节中</em>。</p><h2 id="perf-js-文件代码说明"><a href="#perf-js-文件代码说明" aria-hidden="true" class="header-anchor">#</a> perf.js 文件代码说明</h2><p>这个文件导出两个变量，分别是 <code>mark</code> 和 <code>measure</code>：</p><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">let</span> mark
<span class="token keyword">export</span> <span class="token keyword">let</span> measure
</code></pre><p>接着是下面这段代码：</p><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> perf <span class="token operator">=</span> inBrowser <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>performance
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    perf <span class="token operator">&amp;&amp;</span>
    perf<span class="token punctuation">.</span>mark <span class="token operator">&amp;&amp;</span>
    perf<span class="token punctuation">.</span>measure <span class="token operator">&amp;&amp;</span>
    perf<span class="token punctuation">.</span>clearMarks <span class="token operator">&amp;&amp;</span>
    perf<span class="token punctuation">.</span>clearMeasures
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">mark</span> <span class="token operator">=</span> tag <span class="token operator">=&gt;</span> perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
    <span class="token function-variable function">measure</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      perf<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span>
      perf<span class="token punctuation">.</span><span class="token function">clearMarks</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>
      perf<span class="token punctuation">.</span><span class="token function">clearMarks</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
      perf<span class="token punctuation">.</span><span class="token function">clearMeasures</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>首先判断环境，如果不是生产环境，则继续，否则什么都不做。也就是说，如果是生产环境，那么这个文件导出的两个变量，都是 <code>undefined</code>。</p><p>我们看一下，如果不是生产环境，又做了些什么，首先定义一个变量 <code>perf</code>：</p><pre class="language-js"><code><span class="token keyword">const</span> perf <span class="token operator">=</span> inBrowser <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>performance
</code></pre><p>如果在浏览器环境，那么 <code>perf</code> 的值就是 <code>window.performance</code>，否则为 <code>false</code>，然后做了一些列判断，目的是确定 <code>performance</code> 的接口可用，如果都可用，那么将初始化 <code>mark</code> 和 <code>measure</code> 变量。</p><p>首先看 <code>mark</code>：</p><pre class="language-js"><code><span class="token function-variable function">mark</span> <span class="token operator">=</span> tag <span class="token operator">=&gt;</span> perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
</code></pre><p>实际上，<code>mark</code> 是一个函数，这个函数的作用就是使用给定的 <code>tag</code>，通过 <code>performance.mark()</code> 方法打一个标记。</p><p><code>measure</code> 方法接收三个参数，这三个参数与 <code>performance.measure()</code> 方法所要求的参数相同，它的作用就是调用一下 <code>performance.measure()</code> 方法，然后调用三个清除标记的方法：</p><pre class="language-js"><code>perf<span class="token punctuation">.</span><span class="token function">clearMarks</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>
perf<span class="token punctuation">.</span><span class="token function">clearMarks</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
perf<span class="token punctuation">.</span><span class="token function">clearMeasures</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
</code></pre><p>可以发现，其实 <code>mark</code> 和 <code>measure</code> 这两个函数就是对 <code>performance.mark()</code> 和 <code>performance.measure()</code> 的封装。对于 <code>performance.mark()</code> 和 <code>performance.measure()</code> 这两个方法的详情，大家可以查看 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/mark" target="_blank" rel="noopener noreferrer">Performance</a>，这里我将用一个通俗的说法尽快让大家明白 <code>mark</code> 和 <code>measure</code> 的作用，首先 <code>mark</code> 可以理解为“打标记”，比如如下代码我们在 <code>for</code> 循环的前后各打一个标记：</p><pre class="language-js"><code><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'for-start'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'for-end'</span><span class="token punctuation">)</span>
</code></pre><p>但是仅仅打标记是没有什么用的，这个时候就需要 <code>measure</code> 方法，它能够根据两个标记来计算这两个标记间代码的性能数据，你只需要这样即可：</p><pre class="language-js"><code><span class="token function">measure</span><span class="token punctuation">(</span><span class="token string">'for-measure'</span><span class="token punctuation">,</span> <span class="token string">'for-start'</span><span class="token punctuation">,</span> <span class="token string">'for-end'</span><span class="token punctuation">)</span>
</code></pre><h2 id="props-js-文件代码说明"><a href="#props-js-文件代码说明" aria-hidden="true" class="header-anchor">#</a> props.js 文件代码说明</h2><h2 id="next-tick-js-文件代码说明"><a href="#next-tick-js-文件代码说明" aria-hidden="true" class="header-anchor">#</a> next-tick.js 文件代码说明</h2></div><div class="content edit-link"><a href="https://github.com/HcySunYang/vue-design/edit/master/docs/appendix/core-util.md" target="_blank" rel="noopener noreferrer">错别字纠正</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/vue-design/appendix/vue-ins.html" class="prev">
          Vue 实例的设计
        </a></span><span class="next"><a href="/vue-design/appendix/web-util.html">
          platforms/web/util 目录下的工具方法全解
        </a> →
      </span></p></div></div></div></div>
    <script src="/vue-design/assets/js/26.28b25aff.js" defer></script><script src="/vue-design/assets/js/app.d8bc048b.js" defer></script>
  </body>
</html>
